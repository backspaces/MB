<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Test</title>
        <meta
            name="viewport"
            content="initial-scale=1,maximum-scale=1,user-scalable=no"
        />
        <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
        <link
            href="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css"
            rel="stylesheet"
        />

        <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

        <style>
            body {
                margin: 10;
                padding: 10;
            }
            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                /* height: 800px; */
                width: 95%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script type="module">
            import util from 'https://backspaces.github.io/agentscript/src/util.js'
            import { mapLoad } from './tools.js'

            mapboxgl.accessToken =
                'pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ'

            const ctx = util.createCtx(100, 100, false)
            util.fillCtx(ctx, 'rgba(100,100,100,0.25')
            util.toWindow({ util, map })

            async function run() {
                const counties = await util.xhrPromise(
                    'data/nmcounties.json',
                    'json'
                )
                const bbox = turf.bbox(counties)
                const [west, south, east, north] = bbox
                util.toWindow({ counties, bbox })

                const map = new mapboxgl.Map({
                    container: 'map', // container id
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [(west + east) / 2, (south + north) / 2],
                    zoom: 5.5,
                    renderWorldCopies: false,
                })
                await mapLoad(map)

                map.addLayer({
                    id: 'nmcounties',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        // data: './data/usstates.geojson',
                        data: counties,
                    },
                    paint: {
                        'line-color': 'blue',
                        'line-width': 3,
                    },
                })

                map.addLayer({
                    id: 'BBox',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: turf.featureCollection([turf.bboxPolygon(bbox)]),
                    },
                    paint: {
                        'line-color': 'red',
                    },
                })

                map.addSource('canvas', {
                    type: 'canvas',
                    canvas: ctx.canvas,
                    animate: true,
                    coordinates: [
                        [west, north],
                        [east, north],
                        [east, south],
                        [west, south],
                    ], // 4 [lon,lat] arrays
                })
                map.addLayer({
                    id: 'canvas',
                    type: 'raster',
                    source: 'canvas',
                })
            }
            run()
        </script>
    </body>
</html>
